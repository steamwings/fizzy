servers:
  web:
    hosts:
      - fizzy-staging-app-01
      - fizzy-staging-app-101
    labels:
      otel_scrape_enabled: true
  jobs:
    hosts:
      - fizzy-staging-app-01
    labels:
      otel_scrape_enabled: true

proxy:
  ssl: false

ssh:
  user: app

env:
  clear:
    RAILS_ENV: staging

accessories:
  beamer:
    image: basecamp/beamer:vfs
    registry:
      server: registry.37signals.com
      username: robot$harbor-bot
      password:
        - BASECAMP_REGISTRY_PASSWORD
    labels:
      otel_role: beamer
      otel_service: fizzy-beamer
      otel_scrape_enabled: true
    options:
      user: 1000 # Match the UID of the Rails app, for volume permissions
      publish:
        - 5001:5001
        - 9000:9000
    volumes:
      - fizzy:/home/beamer
    cmd: beamer run --retention=1h --metrics-port=9000
    hosts:
      - fizzy-staging-app-01
      - fizzy-staging-app-101

  load-balancer:
    image: basecamp/kamal-proxy:lb
    host: fizzy-staging-lb-01
    options:
      publish:
        - 80:80
        - 443:443
    volumes:
      - load-balancer:/home/kamal-proxy/.config/kamal-proxy

  otel_collector-load-balancer:
    image: otel/opentelemetry-collector-contrib:0.126.0
    port: 9394
    files:
      - config/otel_collector.yml:/etc/otelcol-contrib/config.yaml
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    options:
      user: 0
    host: fizzy-staging-lb-01
